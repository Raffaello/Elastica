
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Elastica 2.3.0 broken backward compatibility explanation - Elastica</title>
  <meta name="author" content="ruflin">

  
  <meta name="description" content="Elastica 2.3.0 is out and introduced lazy toArray, that broke backward compatibility. Lets talk about this change in details and answer on some &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://Elastica.io/2015/09/22/elastica-2-dot-3-0-broken-backward-compatibility-explanation">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Elastica" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10160648-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Elastica</a></h1>
  
    <h2>A PHP client for elasticsearch.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:Elastica.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/examples/">Examples</a></li>
  <li><a href="/api/">Api</a></li>
  <li><a href="/projects/">Projects</a></li>
  <li><a href="/faq/">FAQ</a></li>
</ul>

</nav>
  <a href="https://github.com/ruflin/Elastica"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Elastica 2.3.0 Broken Backward Compatibility Explanation</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-22T08:23:43+02:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="/2015/09/15/release-2-dot-3-0/">Elastica 2.3.0</a> is out and introduced lazy toArray, that broke backward compatibility. Lets talk about this change in details and answer on some questions, that developers, who use Elastica can have.</p>

<h2>What has changed?</h2>

<p>Lets say we have the following code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$query = new Query();
</span><span class='line'>$termQuery = new Term();
</span><span class='line'>$termQuery-&gt;setTerm('text', 'value');
</span><span class='line'>$query-&gt;setQuery($termQuery);</span></code></pre></td></tr></table></div></figure>


<p>In this example we set the Term object to query. Before version 2.3.0, if you try</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var_dump($query-&gt;getQuery());</span></code></pre></td></tr></table></div></figure>


<p>you will see, that in the result you have an array. This happens, because every objects in setters immediately will be converted to an array and stored as array:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public function setQuery(AbstractQuery $query)
</span><span class='line'>{
</span><span class='line'>    return $this-&gt;setParam('query', $query-&gt;toArray());
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Elastica 2.3.0 broke this behaviour and introduce lazy toArray. This means, that objects always will be stored as is and toArray will be only called when needed. In Elastica&rsquo;s case, this is when performing the request to Elasticsearch. You can rely on, that also after calling toArray - objects will be still be stored as objects.</p>

<h2>Why it was this change made?</h2>

<p>There are a several reasons.</p>

<ul>
<li>In the OOP world, usually what we set is what we get. Now we set objects - and get objects.</li>
<li>In the OOP world we very often extends objects one from another. Code, that is responsible for select objects by Elastica also can extend, and queries will be built step by step from common to specific logic in many places. In this case code will need access to the original query objects, and when they are converted in arrays at setters, query can&rsquo;t be changed without low-level tricks with arrays. After 2.3.0 Elastica changes this behaviour and you always have access to the original objects. You can change query object through the standard usage of Elastica classes.</li>
</ul>


<h2>Is my code broken?</h2>

<p>In most cases if you just used Elastica functions the answer is &ldquo;no&rdquo;. If you answer at least on one of the following question with &ldquo;yes&rdquo;, than your code could be broken:</p>

<ul>
<li>Did you work with Elastica objects on &ldquo;low-level&rdquo;?</li>
<li>Did you change Elastica objects after you set it to another objects?</li>
<li>Did you clone Elastica objects?</li>
</ul>


<p>Lets discuss these question in details.</p>

<h3>Did you work with Elastica objects on &ldquo;low-level&rdquo;?</h3>

<p>When we talk about low-level working with Elastica objects, we are talking about the direct work with Elastica object params, like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$termQuery = $query-&gt;getQuery();
</span><span class='line'>$termQuery['term']['text']['value'] = 'another value';
</span><span class='line'>$query-&gt;setParam('query', $termQuery);</span></code></pre></td></tr></table></div></figure>


<p>Your code will be broken, because getQuery now will return an object instead of array. Remember, it is always bad idea, to work with Elastica params directly if not really necessary.</p>

<h3>Did you change Elastica objects after you set it to another objects?</h3>

<p>Lets say we have the following code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$termQuery = new Term();
</span><span class='line'>$termQuery-&gt;setTerm('text', 'value');
</span><span class='line'>
</span><span class='line'>$query = new Query();
</span><span class='line'>$query-&gt;setQuery($termQuery);
</span><span class='line'>
</span><span class='line'>$termQuery-&gt;setTerm('text', 'another value');
</span><span class='line'>
</span><span class='line'>$anotherQuery = new Query();
</span><span class='line'>$anotherQuery-&gt;setQuery($termQuery);</span></code></pre></td></tr></table></div></figure>


<p>Before 2.3.0 <code>$query-&gt;toArray()</code> and <code>$anotherQuery-&gt;toArray()</code> will not be equal, because we call <code>$query-&gt;setQuery($termQuery)</code>, <code>$termQuery</code> will be stored as an array and changing this object later will no change the array, that is stored in <code>$query</code>.</p>

<p>After 2.3.0 <code>$query-&gt;toArray()</code> and <code>$anotherQuery-&gt;toArray()</code> will be equal, because <code>$termQuery</code> will be stored as object in <code>$query</code>, and if it will be changed somewhere, the result of <code>toArray()</code> will have this changes too.</p>

<h3>Did you clone Elastica objects?</h3>

<p>Lets say we have the following code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$termQuery = new Term();
</span><span class='line'>$termQuery-&gt;setTerm('text', 'value');
</span><span class='line'>
</span><span class='line'>$query = new Query();
</span><span class='line'>$query-&gt;setQuery($termQuery);
</span><span class='line'>$cloned = clone $query;
</span><span class='line'>$termQuery-&gt;setTerm('text', 'another value');</span></code></pre></td></tr></table></div></figure>


<p>Before 2.3.0, <code>$cloned-&gt;toArray()</code> will have a term query with the key <code>text</code> and value <code>value</code> because the <code>$termQuery</code> will be stored as an array and the array will be cloned also.</p>

<p>After 2.3.0 the <code>$termQuery</code> will be stored as object. When clone is called on <code>$query</code>, only the <code>$query</code> object will be cloned, but objects, that are stored will not be cloned. As a result <code>$cloned-&gt;toArray()</code> will have a term query with the value <code>another value</code>.</p>

<h2>Summary</h2>

<p>That are all cases, which can be broken in your projects after the migration to <a href="/2015/09/15/release-2-dot-3-0/">Elastica 2.3.0+</a>. This latest change now gives you the freedom to develop more complex solutions without low-level tricks. Only a very small amount of developers should be affected by the above mentioned issues. In case you have some questions about the changes above, drop us a line on <a href="https://gitter.im/ruflin/Elastica">Gitter</a> so we can help you out.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="http://github.com/ewgRa">ewgRa</a></span></span>

      








  


<time datetime="2015-09-22T08:23:43+02:00" pubdate data-updated="true"></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://Elastica.io/2015/09/22/elastica-2-dot-3-0-broken-backward-compatibility-explanation/" data-via="" data-counturl="http://Elastica.io/2015/09/22/elastica-2-dot-3-0-broken-backward-compatibility-explanation/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2015/09/15/release-2-dot-3-0/" title="Previous Post: Release 2.3.0">&laquo; Release 2.3.0</a>
      
      
        <a class="basic-alignment right" href="/2015/10/18/release-2-dot-3-1/" title="Next Post: Release 2.3.1">Release 2.3.1 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2015/10/18/release-2-dot-3-1/">Release 2.3.1</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/22/elastica-2-dot-3-0-broken-backward-compatibility-explanation/">Elastica 2.3.0 Broken Backward Compatibility Explanation</a>
      </li>
    
      <li class="post">
        <a href="/2015/09/15/release-2-dot-3-0/">Release 2.3.0</a>
      </li>
    
      <li class="post">
        <a href="/2015/08/10/release-2-dot-2-1/">Release 2.2.1</a>
      </li>
    
      <li class="post">
        <a href="/2015/07/08/release-2-dot-2-0/">Release 2.2.0</a>
      </li>
    
  </ul>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/116483615197289019288?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - ruflin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
